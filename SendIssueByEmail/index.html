<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <style>
      body {
        font-family: Arial, sans-serif;
        font-size: 14px;
        padding: 10px;
      }
      ul {
        padding-left: 20px;
      }
      #msg {
        color: green;
      }
      #error {
        color: red;
      }
    </style>
  </head>
  <body>
    <h3>Issue: <span id="issueKey">...</span></h3>
    <p><strong>Summary:</strong> <span id="summary">Loading...</span></p>
    <p><strong>Linked Issues:</strong></p>
    <ul id="linkedIssues"></ul>
    <button id="sendEmailBtn">üìß Send Email</button>
    <p id="msg"></p>
    <p id="error"></p>

    <script>
      AP.context.getContext(async function (context) {
        const issueKey = context?.jira?.issue?.key;

        if (!issueKey) {
          document.getElementById("error").textContent = "‚ùå Issue key not found.";
          return;
        }

        try {
          const res = await fetch("/rest/api/3/issue/" + issueKey + "?fields=summary,issuelinks");
          if (!res.ok) throw new Error("Issue fetch failed: " + res.status);

          const issue = await res.json();

          document.getElementById("issueKey").textContent = issueKey;
          document.getElementById("summary").textContent = issue.fields.summary || "(no summary)";

          const list = document.getElementById("linkedIssues");
          (issue.fields.issuelinks || []).forEach(link => {
            const linked = link.inwardIssue || link.outwardIssue;
            if (linked) {
              const li = document.createElement("li");
              li.textContent = `${link.type.name}: ${linked.key}`;
              list.appendChild(li);
            }
          });

          document.getElementById("sendEmailBtn").onclick = async () => {
            const payload = {
              secret: "your-secret",
              issue: {
                key: issueKey,
                summary: issue.fields.summary
              }
            };

            console.log("Payload:", payload);

            const webhookUrl = "https://api.atlassian.com/automation/webhooks/jira/your-cloud-id/webhook-id";

            const sendRes = await fetch(webhookUrl, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload)
            });

            if (sendRes.ok) {
              document.getElementById("msg").textContent = "‚úÖ Email sent successfully.";
              document.getElementById("error").textContent = "";
            } else {
              document.getElementById("error").textContent = "‚ùå Failed to send email: " + sendRes.status;
              document.getElementById("msg").textContent = "";
            }
          };
        } catch (e) {
          document.getElementById("error").textContent = `‚ùå ${e}`;
        }
      });
    </script>
  </body>
</html>
